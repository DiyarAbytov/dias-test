# Рекомендации по улучшению логики DIYAS

Взгляд как у владельца производства и профи: что не хватает и что улучшить в логике системы.

---

## 1. Связь «Продажа → Отгрузка → Склад ГП»

**Сейчас:** Продажи и отгрузки живут отдельно; остатки на складе ГП не списываются.

**Нужно:**
- При **оформлении продажи** — либо сразу резервировать количество по выбранной партии ГП, либо проверять: «доступно не меньше, чем продаём».
- При **отгрузке** («Подтвердить отгрузку») — списывать количество с выбранной партии на складе ГП (или снимать резерв). Иначе можно «продать» больше, чем есть.
- Запись в **«К отгрузке»** должна появляться из продажи: одна оформленная продажа = одна строка «к отгрузке» (с номером заказа, клиентом, продуктом, кол-вом, датой продажи). Связь по `saleId` или по номеру заказа.

**Итог:** Чёткая цепочка: Склад ГП (остатки) → Продажа (резерв/проверка) → К отгрузке → Отгружено (списание) → Доставлено.

---

## 2. Клиенты и история

**Сейчас:** В продажах может храниться только имя клиента; история клиента — статичный пример.

**Нужно:**
- В **продажах** хранить `clientId` (ссылка на запись в «Клиенты»). Тогда «История клиента» = все продажи/отгрузки с этим `clientId` (дата, продукт, кол-во, цена, сумма, статус доставки).
- При **«Создать клиента»** из формы продажи — после сохранения добавлять клиента в Storage и подставлять его в выбранные в форме продажи (чтобы сразу оформить продажу на нового клиента).

**Итог:** Один источник правды по клиентам, реальная история покупок и доставок.

---

## 3. Уникальные номера документов

**Сейчас:** Номера заказов (SO-…) и накладных (SH-…) можно ввести вручную, возможны дубли.

**Нужно:**
- **Номер заказа продажи** (SO-YYYY-NNN) — генерировать при создании продажи (год + порядковый номер за год).
- **Номер накладной** (SH-YYYY-NNN) — генерировать при подтверждении отгрузки.
- Хранить счётчики в Storage (например, `lastOrderNumber`, `lastShipmentNumber`) и увеличивать при создании.

**Итог:** Нет дублей, удобно искать по номеру и в отчётах.

---

## 4. Защита от удаления «занятых» данных

**Сейчас:** Можно удалить клиента, по которому есть продажи; продукт/партию, которые уже в отгрузке.

**Нужно:**
- При **удалении клиента** — проверять: есть ли продажи/отгрузки с этим `clientId`. Если есть — не удалять, а предложить «Деактивировать» (поле `active: false`) и не показывать в выборе при новой продаже, но оставить в истории.
- При **удалении партии ГП** — не давать удалять, если по ней есть резерв или отгрузка; или только «списать в брак» с комментарием.

**Итог:** Нет «битых» ссылок и противоречий в отчётах.

---

## 5. Низкие остатки (алерты)

**Сейчас:** Остатки на складе сырья и ГП видны, но порог «мало» не задан.

**Нужно:**
- В справочнике **склада сырья** и/или **склада ГП** — поле «Минимальный остаток» (по позиции или по партии).
- В карточках и таблицах остатков — подсветка (бейдж/иконка), если остаток &lt; минимума: «Низкий остаток», «Заказать».
- Опционально: блок на главной/аналитике «Требует внимания: N позиций с низким остатком».

**Итог:** Меньше простоев из‑за отсутствия сырья или готовой продукции.

---

## 6. Даты и аналитика

**Сейчас:** Есть раздел «Аналитика», но связь с реальными данными продаж/отгрузок ограничена.

**Нужно:**
- **Фильтр по периоду** (дата с — дата по) в: Продажи, Отгрузка (все вкладки), История клиента, при необходимости — ОТК, склад ГП.
- В **Аналитике** считать из Storage: объём продаж за период (шт и/или сумма), количество отгрузок, доставок; топ клиентов по сумме/объёму, топ продуктов. Показывать в виде таблиц или простых блоков (карточки/сводка).
- Опционально: сравнение с прошлым периодом (например, «+15% к прошлому месяцу»).

**Итог:** Понимание, сколько продали, отгрузили и доставили за период.

---

## 7. Печать/экспорт документов

**Сейчас:** Накладная и данные отгрузки только на экране.

**Нужно:**
- Кнопки **«Печать накладной»** и **«Печать для клиента»** (счёт/акт) по строке отгрузки или по заказу продажи. Либо отдельная страница «Печать документа» с подставленными полями (клиент, адрес, заказ, позиции, кол-во, цена, сумма, номер накладной, даты).
- Минимум: верстаемая под печать HTML-страница (номера, даты, таблица позиций, подпись), без обязательного PDF (можно «Печать» из браузера).

**Итог:** Удобно отдавать документы клиенту и водителю.

---

## 8. Связь ОТК → Склад ГП

**Сейчас:** Партии после ОТК и приёмка на склад ГП могут быть не связаны.

**Нужно:**
- При статусе **«Принято»** в ОТК по партии — автоматически создавать (или обновлять) запись на **складе ГП**: продукт, количество, партия/дата, статус «Доступна». Либо одна и та же сущность «партия» переходит из производства в ОТК, затем в склад ГП с обновлением статуса.
- Связь по `batchId` / номеру партии: производство → ОТК → склад ГП. Тогда в отгрузке можно указывать конкретную партию ГП.

**Итог:** Прослеживаемость: от производства до отгрузки и до клиента.

---

## 9. Заказы на производство и партии

**Сейчас:** Заказы и производственные партии есть, но связь «заказ принят → создана партия в производстве/ОТК» может быть неочевидной.

**Нужно:**
- При смене статуса заказа на **«Принято»** (или «В работе») — создавать запись партии производства (или задачу в ОТК) с привязкой к заказу (`orderId`). В интерфейсе: по заказу видно партию, по партии — заказ.
- После выпуска и приёмки ОТК — партия попадает на склад ГП (см. п. 8).

**Итог:** Понятная цепочка: заказ → производство → ОТК → склад ГП → продажа → отгрузка → доставка.

---

## 10. Смены и выпуск

**Сейчас:** Есть смены и производство, но выпуск может не быть привязан к смене.

**Нужно:**
- При **выпуске продукции** (производство) указывать или автоматически подставлять **текущую открытую смену** (линия + смена). Хранить в партии `shiftId` или дату/линию смены.
- В отчёте/истории смены: что произведено за смену (по партиям), сколько выпущено по продуктам.

**Итог:** Прозрачность по сменам и объёмам выпуска.

---

## Приоритеты внедрения

| Приоритет | Что делать |
|-----------|------------|
| Высокий   | Связь продажа → отгрузка (одна запись из другой), списание/резерв со склада ГП при продаже и отгрузке (п. 1). |
| Высокий   | `clientId` в продажах, реальная история клиента из данных (п. 2). |
| Высокий   | Уникальные номера заказов и накладных (п. 3). |
| Средний   | Запрет удаления клиента с продажами / деактивация (п. 4). |
| Средний   | ОТК → склад ГП: при «Принято» партия появляется на складе ГП (п. 8). |
| Средний   | Аналитика из реальных данных + фильтр по датам (п. 6). |
| Низкий    | Низкие остатки (п. 5), печать накладной (п. 7), смены и выпуск (п. 10). |

После этого система будет вести полный цикл от заказа на производство до доставки клиенту без «дыр» в логике и с понятными отчётами.
